<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buyurtmani Tasdiqlash</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

    <style>
        body { background-color: #f4f7f6; padding-bottom: 50px; }
        .header { background: #198754; color: white; padding: 15px; display: flex; align-items: center; }
        .back-btn { color: white; text-decoration: none; font-size: 1.5rem; margin-right: 15px; }
        .cart-card { background: #fff; border-radius: 20px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        #map { height: 400px; width: 100%; border-radius: 10px; }
    </style>
</head>
<body>

<div class="header">
    <a href="/cart" class="back-btn">&larr;</a>
    <h4 class="mb-0">Ma'lumotlarni kiriting</h4>
</div>

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="cart-card">

                <form th:action="@{/cart/checkout}" method="post" id="checkoutForm">

                    <div class="mb-3">
                        <label class="form-label fw-bold">Telefon raqam:</label>
                        <input type="tel"
                               class="form-control"
                               name="phone"
                               th:value="${defaultPhone}"
                               placeholder="+998901234567"
                               required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Yetkazib berish manzili:</label>
                        <div class="input-group">
                            <input type="text"
                                   class="form-control"
                                   name="address"
                                   id="address"
                                   placeholder="Xaritadan tanlang"
                                   readonly
                                   required>
                            <button type="button"
                                    class="btn btn-outline-success"
                                    data-bs-toggle="modal"
                                    data-bs-target="#mapModal">
                                üìç Xarita
                            </button>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">To‚Äòlov turi:</label>
                        <select class="form-select" name="paymentType">
                            <option value="cash">Naqd pul</option>
                            <option value="card">Plastik karta</option>
                        </select>
                    </div>

                    <button type="submit"
                            class="btn btn-success w-100 mt-3 py-2 fw-bold">
                        Buyurtmani Yakunlash
                    </button>

                </form>

            </div>
        </div>
    </div>
</div>

<!-- MAP MODAL -->
<div class="modal fade" id="mapModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Manzilni tanlang</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <div id="map"></div>
                <p id="loc-status" class="text-muted mt-2 small">
                    Xaritadan kerakli nuqtani bosing...
                </p>
            </div>

            <div class="modal-footer">
                <button type="button"
                        class="btn btn-success"
                        onclick="confirmLocation()"
                        data-bs-dismiss="modal">
                    Tanlash
                </button>
            </div>

        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    let map, marker, tempAddr = "";

    document.getElementById('mapModal').addEventListener('shown.bs.modal', function () {
        if (!map) {
            map = L.map('map').setView([41.311081, 69.240562], 13);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png')
                .addTo(map);

            map.on('click', function (e) {
                if (marker) marker.setLatLng(e.latlng);
                else marker = L.marker(e.latlng).addTo(map);

                document.getElementById('loc-status').innerText = "Manzil aniqlanmoqda...";

                fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${e.latlng.lat}&lon=${e.latlng.lng}`)
                    .then(res => res.json())
                    .then(data => {
                        tempAddr = data.display_name;
                        document.getElementById('loc-status').innerText = "Tanlandi: " + tempAddr;
                    });
            });
        }
        map.invalidateSize();
    });

    function confirmLocation() {
        if (tempAddr) {
            document.getElementById("address").value = tempAddr;
        }
    }

    // FORM SUBMIT (FETCH)
    document.getElementById('checkoutForm').addEventListener('submit', function (e) {
        e.preventDefault();

        fetch(this.action, {
            method: 'POST',
            body: new FormData(this)
        }).then(res => {
            if (res.ok) {
                window.location.href = '/orders';
            } else {
                alert("Xatolik yuz berdi!");
            }
        });
    });
</script>

</body>
</html>
